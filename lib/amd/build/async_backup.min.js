define(["jquery","core/ajax","core/str"],function(a,b,c){function d(b,c){var d=a("#"+b+"_bar"),e=c+"%";d.attr("aria-valuenow",c),d.attr("width",e),d.text(e)}function e(c){var d=a("#"+c+"_bar").parent().parent(),e=d.siblings(),f=e[2],g=e[3],h=e[4],i=e[0],j=a(i).text();b.call([{methodname:"core_backup_async_backup_links_backup",args:{filename:j,contextid:l}}])[0].done(function(b){a(f).html(b.filesize),a(g).html(b.dowloadlink),a(h).html(b.restorelink),a(d).html(b.status)})}function f(c){var d=a("#"+c+"_bar").parent().parent(),e=d.siblings(),f=e[0];b.call([{methodname:"core_backup_async_backup_links_restore",args:{backupid:c,contextid:l}}])[0].done(function(b){var c=a(f).text(),e=a("<a>",{text:c,href:b.restoreurl});a(d).html(b.status),a(f).html(e)})}function g(e){var f=100*Math.round(e.progress),g=a("#"+k+"_bar"),h=a("#"+k+"_status"),i=a("#"+k+"_detail"),j=a("#"+k+"_button");800==e.status?(g.addClass("bg-success"),d(k,f),c.get_string("async"+n+"processing","backup").then(function(a){h.text(a)})):900==e.status?(g.addClass("bg-danger"),g.removeClass("bg-success"),d(k,100),c.get_string("async"+n+"error","backup").then(function(a){h.text(a)}),c.get_string("async"+n+"errordetail","backup").then(function(a){i.text(a)}),a(".backup_progress").children("span").removeClass("backup_stage_current"),a(".backup_progress").children("span").last().addClass("backup_stage_current"),clearInterval(o)):1e3==e.status&&(g.addClass("bg-success"),d(k,100),c.get_string("async"+n+"complete","backup").then(function(a){h.text(a)}),"restore"==n?b.call([{methodname:"core_backup_async_backup_links_restore",args:{backupid:k,contextid:l}}])[0].done(function(a){c.get_string("async"+n+"completedetail","backup",a.restoreurl).then(function(a){i.html(a)}),c.get_string("async"+n+"completebutton","backup").then(function(b){j.text(b),j.attr("href",a.restoreurl)})}):(c.get_string("async"+n+"completedetail","backup",m).then(function(a){i.html(a)}),c.get_string("async"+n+"completebutton","backup").then(function(a){j.text(a),j.attr("href",m)})),a(".backup_progress").children("span").removeClass("backup_stage_current"),a(".backup_progress").children("span").last().addClass("backup_stage_current"),clearInterval(o))}function h(b){b.forEach(function(b){var c=100*Math.round(b.element),g=b.backupid,h=a("#"+g+"_bar");800==b.status?(h.addClass("bg-success"),d(g,c)):900==b.status?(h.addClass("bg-danger"),h.addClass("complete"),a("#"+g+"_bar").removeClass("bg-success"),d(g,100)):1e3==b.status&&(h.addClass("bg-success"),h.addClass("complete"),d(g,100),"backup"==n?e(g):f(g))})}function i(){b.call([{methodname:"core_backup_async_backup_progress",args:{backupids:[k],contextid:l}}])[0].done(function(a){g(a[0])})}function j(){var c=[],d=a(".progress").find(".progress-bar").not(".complete");d.each(function(){c.push(this.id.substring(0,32))}),c.length>0?b.call([{methodname:"core_backup_async_backup_progress",args:{backupids:c,contextid:l}}])[0].done(function(a){h(a)}):clearInterval(p)}var k,l,m,n,o,p,q={},r=5e3;return q.asyncBackupAllStatus=function(a){l=a,p=setInterval(j,r)},q.asyncBackupStatus=function(b,c,d,e){k=b,l=c,m=d,n="backup"==e?"backup":"restore",a(".backup_progress").children("a").removeAttr("href"),o=setInterval(i,r)},q});