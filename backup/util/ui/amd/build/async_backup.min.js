define(["jquery","core/ajax","core/str","core/notification"],function(a,b,c,d){function e(b,c){var d=Math.round(c)+"%",e=a("#"+b+"_bar"),f=c.toFixed(2)+"%";e.attr("aria-valuenow",d),e.css("width",d),e.text(f)}function f(c){var d=a("#"+c+"_bar").parent().parent(),e=d.siblings(),f=e[2],g=e[3],h=e[4],i=e[0],j=a(i).text();b.call([{methodname:"core_backup_get_async_backup_links_backup",args:{filename:j,contextid:m}}])[0].done(function(b){a(f).html(b.filesize),a(g).html(b.dowloadlink),a(h).html(b.restorelink),a(d).html(b.status)})}function g(c){var d=a("#"+c+"_bar").parent().parent(),e=d.siblings(),f=e[0];b.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:c,contextid:m}}])[0].done(function(b){var c=a(f).text(),e=a("<a>",{text:c,href:b.restoreurl});a(d).html(b.status),a(f).html(e)})}function h(f){var g=100*f.progress,h=a("#"+l+"_bar"),i=a("#"+l+"_status"),j=a("#"+l+"_detail"),k=a("#"+l+"_button");if(f.status==r){h.addClass("bg-success"),e(l,g);var q="async"+o+"processing";c.get_string(q,"backup").then(function(a){return i.text(a),a})["catch"](function(){d.exception(new Error("Failed to load string: backup "+q))})}else if(f.status==s){h.addClass("bg-danger"),h.removeClass("bg-success"),e(l,100);var u="async"+o+"error",v="async"+o+"errordetail",w=[{key:u,component:"backup"},{key:v,component:"backup"}];c.get_strings(w).then(function(a){return i.text(a[0]),j.text(a[1]),a})["catch"](function(){d.exception(new Error("Failed to load string"))}),a(".backup_progress").children("span").removeClass("backup_stage_current"),a(".backup_progress").children("span").last().addClass("backup_stage_current"),clearInterval(p)}else if(f.status==t){h.addClass("bg-success"),e(l,100);var x="async"+o+"complete";if(c.get_string(x,"backup").then(function(a){return i.text(a),a})["catch"](function(){d.exception(new Error("Failed to load string: backup "+x))}),"restore"==o)b.call([{methodname:"core_backup_get_async_backup_links_restore",args:{backupid:l,contextid:m}}])[0].done(function(a){var b="async"+o+"completedetail",e="async"+o+"completebutton",f=[{key:b,component:"backup",param:a.restoreurl},{key:e,component:"backup"}];c.get_strings(f).then(function(b){return j.html(b[0]),k.text(b[1]),k.attr("href",a.restoreurl),b})["catch"](function(){d.exception(new Error("Failed to load string"))})});else{var y="async"+o+"completedetail",z="async"+o+"completebutton",w=[{key:y,component:"backup",param:n},{key:z,component:"backup"}];c.get_strings(w).then(function(a){return j.html(a[0]),k.text(a[1]),k.attr("href",n),a})["catch"](function(){d.exception(new Error("Failed to load string"))})}a(".backup_progress").children("span").removeClass("backup_stage_current"),a(".backup_progress").children("span").last().addClass("backup_stage_current"),clearInterval(p)}}function i(b){b.forEach(function(b){var c=100*b.progress,d=b.backupid,h=a("#"+d+"_bar"),i=b.operation;b.status==r?(h.addClass("bg-success"),e(d,c)):b.status==s?(h.addClass("bg-danger"),h.addClass("complete"),a("#"+d+"_bar").removeClass("bg-success"),e(d,100)):b.status==t&&(h.addClass("bg-success"),h.addClass("complete"),e(d,100),"backup"==i?f(d):g(d))})}function j(){b.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:[l],contextid:m}}])[0].done(function(a){h(a[0])})}function k(){var c=[],d=a(".progress").find(".progress-bar").not(".complete");d.each(function(){c.push(this.id.substring(0,32))}),c.length>0?b.call([{methodname:"core_backup_get_async_backup_progress",args:{backupids:c,contextid:m}}])[0].done(function(a){i(a)}):clearInterval(q)}var l,m,n,o,p,q,r=800,s=900,t=1e3,u={},v=5e3;return u.asyncBackupAllStatus=function(a){m=a,q=setInterval(k,v)},u.asyncBackupStatus=function(b,c,d,e){l=b,m=c,n=d,o="backup"==e?"backup":"restore",a(".backup_progress").children("a").removeAttr("href"),p=setInterval(j,v)},u});