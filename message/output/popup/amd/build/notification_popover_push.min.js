define("message_popup/notification_popover_push",["exports","core/ajax","core/modal_cancel","core/modal_events","core/str"],(function(_exports,_ajax,_modal_cancel,_modal_events,_str){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_ajax=_interopRequireDefault(_ajax),_modal_cancel=_interopRequireDefault(_modal_cancel),_modal_events=_interopRequireDefault(_modal_events);const arrayBufferToBase64=buffer=>{let base64String="";const bytes=new Uint8Array(buffer);for(let i=0;i<bytes.byteLength;i++)base64String+=String.fromCharCode(bytes[i]);return window.btoa(base64String)},setupSubscription=async vapidpublickey=>{const workerRegistration=await(async()=>{let registration;try{const workerUri="/message/output/popup/amd/build/notification_service_worker.min.js";registration=await navigator.serviceWorker.register(workerUri),navigator.serviceWorker.addEventListener("message",(event=>{window.console.log("Received message from service worker:",event.data.message)}))}catch(error){if("NotAllowedError"!==error.name)throw error;window.console.error("Permission for Push API has been denied")}return registration})();let subscription=await workerRegistration.pushManager.getSubscription();if(!subscription){const options={userVisibleOnly:!0,applicationServerKey:(base64String=>{const base64=(base64String+"=".repeat((4-base64String.length%4)%4)).replace(/-/g,"+").replace(/_/g,"/"),rawData=window.atob(base64),outputArray=new Uint8Array(rawData.length);for(let i=0;i<rawData.length;++i)outputArray[i]=rawData.charCodeAt(i);return outputArray})(vapidpublickey)};subscription=await workerRegistration.pushManager.subscribe(options),await registerPushSubscription(subscription).catch((error=>{throw subscription.unsubscribe(),error}))}},registerPushSubscription=async subscription=>{const request={methodname:"message_popup_register_push_subscription",args:{endpoint:subscription.endpoint,expirationtime:subscription.expirationTime,auth:arrayBufferToBase64(subscription.getKey("auth")),p256dh:arrayBufferToBase64(subscription.getKey("p256dh"))}};return _ajax.default.call([request])[0]},pushModalClose=async vapidpublickey=>{"granted"===await window.Notification.requestPermission()?await setupSubscription(vapidpublickey):window.console.error("Notification permission denied.")};_exports.init=async vapidpublickey=>{if("denied"!==window.Notification.permission)if("granted"===window.Notification.permission)window.console.log("Notification permission granted."),await setupSubscription(vapidpublickey);else{window.console.log("Notification permission not granted. Requesting permission...");const modalStrings=await(0,_str.getStrings)([{key:"pushmodaltitle",component:"message_popup"},{key:"pushmodalbody",component:"message_popup"},{key:"ok",component:"core"}]),modal=await _modal_cancel.default.create({title:modalStrings[0],body:modalStrings[1],show:!0,removeOnClose:!0});modal.setButtonText("cancel","OK"),modal.getRoot().on(_modal_events.default.cancel,(async()=>{pushModalClose(vapidpublickey)})),modal.getRoot().on(_modal_events.default.hidden,(async()=>{pushModalClose(vapidpublickey)}))}else window.console.error("Notification permission denied.")}}));

//# sourceMappingURL=notification_popover_push.min.js.map